name: CI/CD for production

on:
  push:
    branches: ["main"]

jobs:
  build_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PRIVATE_REPOSITORIES_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Docker image
        uses: docker/bake-action@v5
        with:
          files: docker-compose.yml
          targets: backend
          push: false
          set: |
            *.cache-from=type=gha,scope=backend
            *.cache-to=type=gha,mode=max,scope=backend

  build_frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PRIVATE_REPOSITORIES_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Docker image
        uses: docker/bake-action@v5
        with:
          files: docker-compose.yml
          targets: frontend
          push: false
          set: |
            *.cache-from=type=gha,scope=frontend
            *.cache-to=type=gha,mode=max,scope=frontend

  deploy:
    needs: [build_backend, build_frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PRIVATE_REPOSITORIES_TOKEN }}

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_API }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          debug: true
          sync: true
          script: |
            Write-Host "Current Identity: $(whoami)"
            Write-Host "Current Directory: $(Get-Location)"

            cd FK

            Write-Host "Directory content:"
            Get-ChildItem

            Write-Host "Creating .env file..."
            Set-Content -Path .env -Value "
              POSTGRES_USER=${{ secrets.POSTGRES_USER }}
              POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
              POSTGRES_DB=${{ secrets.POSTGRES_DB }}
              PGADMIN_DEFAULT_EMAIL=${{ secrets.PGADMIN_DEFAULT_EMAIL }}
              PGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
              DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
              DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
              DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
              CLOUDPUB_TOKEN=${{ secrets.CLOUDPUB_TOKEN }}
              HOST=${{ vars.HOST }}
            " -Encoding UTF8

            Write-Host "Starting build script..."
            & ./build.ps1 *>&1

  health_check:
    needs: deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Health check
        run: |
          HOST_URL="${{ vars.HOST }}"

          echo ""
          echo "Testing connectivity..."
          MAX_RETRIES=25
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --connect-timeout 5 "$HOST_URL" 2>&1) || HTTP_CODE="000"
            
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES - HTTP Code: $HTTP_CODE"
            
            if [[ "$HTTP_CODE" =~ ^[23] ]]; then
              echo "✅ Health check passed!"
              exit 0
            fi
            
            
            RETRY_COUNT=$((RETRY_COUNT+1))
            sleep 10
          done

          echo ""
          echo "❌ Health check failed after $MAX_RETRIES attempts"
          echo ""
